<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SuiteScript Generator — Architecture Map</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#0d1117; color:#c9d1d9; height:100vh; overflow:hidden; }
.app { display:grid; grid-template-columns:300px 1fr; grid-template-rows:1fr auto; height:100vh; }
.sidebar { background:#161b22; border-right:1px solid #30363d; overflow-y:auto; padding:12px; grid-row:1/3; }
.sidebar::-webkit-scrollbar { width:6px; }
.sidebar::-webkit-scrollbar-thumb { background:#30363d; border-radius:3px; }
.sidebar h2 { font-size:14px; color:#58a6ff; margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid #30363d; }
.section-label { font-size:11px; color:#8b949e; text-transform:uppercase; letter-spacing:.5px; margin:12px 0 6px; }
.preset-grid { display:grid; grid-template-columns:1fr 1fr; gap:4px; margin-bottom:12px; }
.preset-btn { background:#21262d; border:1px solid #30363d; color:#8b949e; padding:6px 8px; border-radius:6px; font-size:11px; cursor:pointer; text-align:center; transition:all .15s; }
.preset-btn:hover { border-color:#58a6ff; color:#c9d1d9; }
.preset-btn.active { background:#1f6feb22; border-color:#58a6ff; color:#58a6ff; }
.check-row { display:flex; align-items:center; gap:8px; padding:3px 0; }
.check-row input { accent-color:#58a6ff; }
.check-row label { font-size:12px; color:#c9d1d9; cursor:pointer; display:flex; align-items:center; gap:6px; }
.color-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
.conn-check label { display:flex; align-items:center; gap:6px; }
.conn-line { width:20px; height:2px; display:inline-block; border-radius:1px; }
.comment-list { margin-top:8px; }
.comment-item { background:#0d1117; border:1px solid #21262d; border-radius:6px; padding:8px; margin-bottom:6px; position:relative; }
.comment-item .target { font-size:11px; color:#58a6ff; font-weight:600; }
.comment-item .file { font-size:10px; color:#484f58; font-family:'SF Mono',monospace; }
.comment-item .text { font-size:12px; color:#c9d1d9; margin-top:4px; }
.comment-item .del { position:absolute; top:6px; right:8px; background:none; border:none; color:#f85149; cursor:pointer; font-size:14px; }
.no-comments { font-size:12px; color:#484f58; font-style:italic; padding:8px; }
.canvas-area { position:relative; overflow:hidden; background:#0d1117; }
.canvas-area svg { width:100%; height:100%; }
.zoom-controls { position:absolute; top:12px; right:12px; display:flex; gap:4px; }
.zoom-btn { background:#21262d; border:1px solid #30363d; color:#c9d1d9; width:28px; height:28px; border-radius:4px; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; }
.zoom-btn:hover { border-color:#58a6ff; }
.legend { position:absolute; bottom:12px; left:12px; background:#161b22ee; border:1px solid #30363d; border-radius:8px; padding:10px 14px; }
.legend h4 { font-size:10px; color:#8b949e; text-transform:uppercase; letter-spacing:.5px; margin-bottom:6px; }
.legend-row { display:flex; align-items:center; gap:6px; padding:2px 0; font-size:11px; color:#c9d1d9; }
.prompt-panel { background:#161b22; border-top:1px solid #30363d; padding:12px 16px; max-height:180px; overflow-y:auto; }
.prompt-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.prompt-header h3 { font-size:12px; color:#8b949e; text-transform:uppercase; letter-spacing:.5px; }
.copy-btn { background:#21262d; border:1px solid #30363d; color:#c9d1d9; padding:4px 12px; border-radius:4px; font-size:12px; cursor:pointer; }
.copy-btn:hover { border-color:#58a6ff; color:#58a6ff; }
.copy-btn.copied { background:#23863633; border-color:#238636; color:#3fb950; }
.prompt-text { font-size:13px; line-height:1.5; color:#c9d1d9; white-space:pre-wrap; }
/* Modal */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100; align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; }
.modal { background:#161b22; border:1px solid #30363d; border-radius:10px; padding:20px; width:400px; max-width:90vw; }
.modal h3 { font-size:14px; color:#c9d1d9; margin-bottom:4px; }
.modal .file { font-size:11px; color:#484f58; font-family:'SF Mono',monospace; margin-bottom:12px; }
.modal textarea { width:100%; height:80px; background:#0d1117; border:1px solid #30363d; color:#c9d1d9; border-radius:6px; padding:8px; font-size:13px; font-family:inherit; resize:vertical; }
.modal textarea:focus { outline:none; border-color:#58a6ff; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
.modal-actions button { padding:6px 16px; border-radius:6px; font-size:13px; cursor:pointer; border:1px solid #30363d; }
.modal-actions .save { background:#238636; border-color:#238636; color:#fff; }
.modal-actions .cancel { background:#21262d; color:#c9d1d9; }
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <h2>Architecture Map</h2>

    <div class="section-label">Presets</div>
    <div class="preset-grid">
      <button class="preset-btn active" onclick="applyPreset('full')">Full System</button>
      <button class="preset-btn" onclick="applyPreset('core')">Core Only</button>
      <button class="preset-btn" onclick="applyPreset('thinedge')">Thin Edge</button>
      <button class="preset-btn" onclick="applyPreset('dataflow')">Data Flow</button>
      <button class="preset-btn" onclick="applyPreset('assembly')">Assembly Rules</button>
      <button class="preset-btn" onclick="applyPreset('generated')">Generated Output</button>
    </div>

    <div class="section-label">Layers</div>
    <div id="layer-filters"></div>

    <div class="section-label">Connection Types</div>
    <div id="conn-filters"></div>

    <div class="section-label">Comments (<span id="comment-count">0</span>)</div>
    <div class="comment-list" id="comment-list">
      <div class="no-comments">Click a component to add feedback</div>
    </div>
  </div>

  <div class="canvas-area" id="canvas-area">
    <svg id="svg-canvas" viewBox="0 0 1200 800"></svg>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoom(1.15)">+</button>
      <button class="zoom-btn" onclick="zoom(1/1.15)">−</button>
      <button class="zoom-btn" onclick="resetZoom()" style="font-size:11px">⟲</button>
    </div>
    <div class="legend">
      <h4>Layers</h4>
      <div class="legend-row"><span class="color-dot" style="background:#dbeafe"></span> FC UI / Authoring</div>
      <div class="legend-row"><span class="color-dot" style="background:#fef3c7"></span> IR / Schema</div>
      <div class="legend-row"><span class="color-dot" style="background:#f3e8ff"></span> Core Components</div>
      <div class="legend-row"><span class="color-dot" style="background:#dcfce7"></span> Generator / Templates</div>
      <div class="legend-row"><span class="color-dot" style="background:#fce7f3"></span> Generated Output</div>
    </div>
  </div>

  <div class="prompt-panel">
    <div class="prompt-header">
      <h3>Architecture Feedback</h3>
      <button class="copy-btn" onclick="copyPrompt()">Copy Prompt</button>
    </div>
    <div class="prompt-text" id="prompt-output">Click components on the map to add architecture feedback and implementation notes.</div>
  </div>
</div>

<!-- Comment Modal -->
<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h3 id="modal-title"></h3>
    <div class="file" id="modal-file"></div>
    <textarea id="modal-text" placeholder="Add your feedback or implementation note..."></textarea>
    <div class="modal-actions">
      <button class="cancel" onclick="closeModal()">Cancel</button>
      <button class="save" onclick="saveComment()">Save</button>
    </div>
  </div>
</div>

<script>
// --- Layer definitions ---
const LAYERS = {
  fcui:      { label:'FC UI / Authoring',   color:'#dbeafe', textColor:'#1e3a5f', yBand:30 },
  ir:        { label:'IR / Schema',          color:'#fef3c7', textColor:'#78350f', yBand:150 },
  core:      { label:'Core Components',      color:'#f3e8ff', textColor:'#4c1d95', yBand:310 },
  generator: { label:'Generator / Templates', color:'#dcfce7', textColor:'#14532d', yBand:500 },
  output:    { label:'Generated Output',      color:'#fce7f3', textColor:'#831843', yBand:650 }
};

// --- Connection types ---
const CONN_TYPES = {
  authors:    { label:'Authors / Produces',  color:'#3b82f6', dash:'' },
  validates:  { label:'Validates',           color:'#f59e0b', dash:'6,3' },
  consumes:   { label:'Consumes / Reads',    color:'#10b981', dash:'' },
  generates:  { label:'Generates',           color:'#ef4444', dash:'4,4' },
  invokes:    { label:'Invokes / Calls',     color:'#8b5cf6', dash:'8,4' },
  uses:       { label:'Uses / Depends',      color:'#6b7280', dash:'3,3' }
};

// --- Nodes ---
const NODES = [
  // FC UI layer
  { id:'fc-ui', label:'FC Authoring UI', subtitle:'Browser-based config tool', layer:'fcui', x:500, y:40, w:200, h:50 },

  // IR layer
  { id:'ir-schema', label:'ir.schema.json', subtitle:'schema/ir.schema.json', layer:'ir', x:300, y:150, w:180, h:50 },
  { id:'ir-instance', label:'IR Instance', subtitle:'ir/customer_upsert.json', layer:'ir', x:600, y:150, w:180, h:50 },

  // Core components
  { id:'runner', label:'Runner', subtitle:'src/core/runner.js', layer:'core', x:500, y:280, w:160, h:45 },
  { id:'logger', label:'Logger', subtitle:'src/core/logger.js', layer:'core', x:80, y:280, w:130, h:45 },
  { id:'errors', label:'ErrorMapper', subtitle:'src/core/errors.js', layer:'core', x:80, y:340, w:130, h:45 },
  { id:'auth', label:'AuthRoleGate', subtitle:'src/core/auth.js', layer:'core', x:280, y:280, w:150, h:45 },
  { id:'validate', label:'InputValidator', subtitle:'src/core/validate.js', layer:'core', x:280, y:340, w:150, h:45 },
  { id:'response', label:'ResponseEnvelope', subtitle:'src/core/response.js', layer:'core', x:280, y:400, w:150, h:45 },
  { id:'dal-records', label:'RecordDAL', subtitle:'src/core/dal/records.js', layer:'core', x:720, y:280, w:150, h:45 },
  { id:'dal-search', label:'SearchDAL', subtitle:'src/core/dal/search.js', layer:'core', x:720, y:340, w:150, h:45 },
  { id:'transform', label:'Transform', subtitle:'src/core/transform.js', layer:'core', x:720, y:400, w:150, h:45 },
  { id:'governance', label:'GovernancePolicy', subtitle:'src/core/governance.js', layer:'core', x:940, y:280, w:160, h:45 },
  { id:'idempotency', label:'IdempotencyGuard', subtitle:'src/core/idempotency.js', layer:'core', x:940, y:340, w:160, h:45 },
  { id:'correlation', label:'CorrelationId', subtitle:'src/core/correlation.js', layer:'core', x:940, y:400, w:160, h:45 },

  // Generator layer
  { id:'gen-cli', label:'Generator CLI', subtitle:'gen.js', layer:'generator', x:400, y:510, w:170, h:45 },
  { id:'tpl-restlet', label:'RESTlet Template', subtitle:'templates/edge/restlet.hbs', layer:'generator', x:650, y:510, w:170, h:45 },
  { id:'tpl-scheduled', label:'Scheduled Template', subtitle:'templates/edge/scheduled.hbs', layer:'generator', x:880, y:510, w:180, h:45 },

  // Generated output
  { id:'out-restlet', label:'RESTlet Script', subtitle:'dist/edge/restlet_*.js', layer:'output', x:150, y:650, w:170, h:45 },
  { id:'out-scheduled', label:'Scheduled Script', subtitle:'dist/edge/scheduled_*.js', layer:'output', x:370, y:650, w:170, h:45 },
  { id:'out-usecase', label:'Usecase Module', subtitle:'src/usecases/generated/*.js', layer:'output', x:590, y:650, w:170, h:45 },
  { id:'out-manifest', label:'Manifest', subtitle:'dist/manifest/*.json', layer:'output', x:810, y:650, w:140, h:45 },
  { id:'out-readme', label:'README', subtitle:'dist/README_*.md', layer:'output', x:990, y:650, w:120, h:45 }
];

// --- Connections ---
const CONNECTIONS = [
  // FC UI → IR
  { from:'fc-ui', to:'ir-instance', type:'authors', label:'outputs' },
  // IR schema validates instance
  { from:'ir-schema', to:'ir-instance', type:'validates', label:'validates' },
  // IR → Generator
  { from:'ir-instance', to:'gen-cli', type:'consumes', label:'consumed by' },
  // Generator uses templates
  { from:'gen-cli', to:'tpl-restlet', type:'uses', label:'uses' },
  { from:'gen-cli', to:'tpl-scheduled', type:'uses', label:'uses' },
  // Generator generates output
  { from:'gen-cli', to:'out-restlet', type:'generates', label:'generates' },
  { from:'gen-cli', to:'out-scheduled', type:'generates', label:'generates' },
  { from:'gen-cli', to:'out-usecase', type:'generates', label:'generates' },
  { from:'gen-cli', to:'out-manifest', type:'generates', label:'generates' },
  { from:'gen-cli', to:'out-readme', type:'generates', label:'generates' },
  // Edge scripts → Runner (thin edge)
  { from:'out-restlet', to:'runner', type:'invokes', label:'calls run()' },
  { from:'out-scheduled', to:'runner', type:'invokes', label:'calls run()' },
  // Runner → Core components (assembly rules)
  { from:'runner', to:'auth', type:'invokes', label:'auth.roleGate' },
  { from:'runner', to:'validate', type:'invokes', label:'validate.schema' },
  { from:'runner', to:'dal-records', type:'invokes', label:'record.upsert' },
  { from:'runner', to:'dal-search', type:'invokes', label:'search.lookup' },
  { from:'runner', to:'response', type:'invokes', label:'response.envelope' },
  { from:'runner', to:'governance', type:'invokes', label:'governance.apply' },
  { from:'runner', to:'correlation', type:'invokes', label:'injects' },
  { from:'runner', to:'logger', type:'uses', label:'logs' },
  { from:'runner', to:'errors', type:'uses', label:'error handling' },
  // Cross-component deps
  { from:'dal-search', to:'governance', type:'uses', label:'pagination' },
  { from:'errors', to:'response', type:'uses', label:'toEnvelope' },
  { from:'auth', to:'logger', type:'uses', label:'logs' },
  { from:'dal-records', to:'logger', type:'uses', label:'logs' },
  { from:'dal-search', to:'logger', type:'uses', label:'logs' },
  // Usecase module uses core
  { from:'out-usecase', to:'runner', type:'invokes', label:'assembled pipeline' }
];

// --- State ---
let viewState = {
  layers: { fcui:true, ir:true, core:true, generator:true, output:true },
  connTypes: { authors:true, validates:true, consumes:true, generates:true, invokes:true, uses:true },
  scale: 1,
  panX: 0, panY: 0,
  comments: [],
  activePreset: 'full'
};

let modalNodeId = null;
let isPanning = false, panStart = {x:0,y:0};

// --- Presets ---
const PRESETS = {
  full: { layers:{fcui:true,ir:true,core:true,generator:true,output:true}, connTypes:{authors:true,validates:true,consumes:true,generates:true,invokes:true,uses:true} },
  core: { layers:{fcui:false,ir:false,core:true,generator:false,output:false}, connTypes:{authors:false,validates:false,consumes:false,generates:false,invokes:true,uses:true} },
  thinedge: { layers:{fcui:false,ir:false,core:true,generator:false,output:true}, connTypes:{authors:false,validates:false,consumes:false,generates:false,invokes:true,uses:false} },
  dataflow: { layers:{fcui:true,ir:true,core:true,generator:true,output:true}, connTypes:{authors:true,validates:false,consumes:true,generates:true,invokes:false,uses:false} },
  assembly: { layers:{fcui:false,ir:true,core:true,generator:false,output:false}, connTypes:{authors:false,validates:false,consumes:true,generates:false,invokes:true,uses:false} },
  generated: { layers:{fcui:false,ir:false,core:false,generator:true,output:true}, connTypes:{authors:false,validates:false,consumes:false,generates:true,invokes:false,uses:true} }
};

function applyPreset(name) {
  const p = PRESETS[name];
  viewState.layers = {...p.layers};
  viewState.connTypes = {...p.connTypes};
  viewState.activePreset = name;
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  renderFilters();
  render();
}

// --- Render filters ---
function renderFilters() {
  const lf = document.getElementById('layer-filters');
  lf.innerHTML = Object.entries(LAYERS).map(([k,v]) =>
    `<div class="check-row"><input type="checkbox" id="layer-${k}" ${viewState.layers[k]?'checked':''} onchange="viewState.layers['${k}']=this.checked;render()"><label for="layer-${k}"><span class="color-dot" style="background:${v.color}"></span>${v.label}</label></div>`
  ).join('');

  const cf = document.getElementById('conn-filters');
  cf.innerHTML = Object.entries(CONN_TYPES).map(([k,v]) =>
    `<div class="check-row conn-check"><input type="checkbox" id="conn-${k}" ${viewState.connTypes[k]?'checked':''} onchange="viewState.connTypes['${k}']=this.checked;render()"><label for="conn-${k}"><span class="conn-line" style="background:${v.color}"></span>${v.label}</label></div>`
  ).join('');
}

// --- SVG Rendering ---
function getNodeCenter(node) {
  return { x: node.x + node.w/2, y: node.y + node.h/2 };
}

function render() {
  const svg = document.getElementById('svg-canvas');
  const visibleNodes = NODES.filter(n => viewState.layers[n.layer]);
  const visibleNodeIds = new Set(visibleNodes.map(n => n.id));
  const visibleConns = CONNECTIONS.filter(c =>
    viewState.connTypes[c.type] && visibleNodeIds.has(c.from) && visibleNodeIds.has(c.to)
  );

  const commentedIds = new Set(viewState.comments.map(c => c.nodeId));

  let html = '';

  // Defs (arrowheads)
  html += '<defs>';
  Object.entries(CONN_TYPES).forEach(([k,v]) => {
    html += `<marker id="arrow-${k}" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="${v.color}" opacity="0.7"/></marker>`;
  });
  html += '</defs>';

  // Transform group
  html += `<g transform="translate(${viewState.panX},${viewState.panY}) scale(${viewState.scale})">`;

  // Layer bands (background)
  Object.entries(LAYERS).forEach(([k,v]) => {
    if(!viewState.layers[k]) return;
    html += `<rect x="20" y="${v.yBand - 20}" width="1160" height="${k==='core'?190:80}" rx="8" fill="${v.color}" opacity="0.04"/>`;
    html += `<text x="35" y="${v.yBand - 4}" font-size="10" fill="${v.color}" opacity="0.5" font-weight="600" text-transform="uppercase">${v.label.toUpperCase()}</text>`;
  });

  // Connections
  visibleConns.forEach(c => {
    const fromNode = NODES.find(n => n.id === c.from);
    const toNode = NODES.find(n => n.id === c.to);
    if(!fromNode || !toNode) return;
    const f = getNodeCenter(fromNode);
    const t = getNodeCenter(toNode);
    const ct = CONN_TYPES[c.type];
    const dx = t.x - f.x, dy = t.y - f.y;
    const cpOffset = Math.min(Math.abs(dy) * 0.4, 60);
    const cp1x = f.x, cp1y = f.y + cpOffset;
    const cp2x = t.x, cp2y = t.y - cpOffset;
    html += `<path d="M${f.x},${f.y} C${cp1x},${cp1y} ${cp2x},${cp2y} ${t.x},${t.y}" fill="none" stroke="${ct.color}" stroke-width="1.5" opacity="0.5" ${ct.dash?`stroke-dasharray="${ct.dash}"`:''} marker-end="url(#arrow-${c.type})"/>`;
  });

  // Nodes
  visibleNodes.forEach(n => {
    const layer = LAYERS[n.layer];
    const hasComment = commentedIds.has(n.id);
    html += `<g class="node" onclick="openModal('${n.id}')" style="cursor:pointer">`;
    html += `<rect x="${n.x}" y="${n.y}" width="${n.w}" height="${n.h}" rx="8" fill="${layer.color}" stroke="${hasComment?'#58a6ff':layer.color}" stroke-width="${hasComment?2.5:1}" opacity="0.9"/>`;
    if(hasComment) {
      html += `<circle cx="${n.x+n.w-8}" cy="${n.y+8}" r="6" fill="#58a6ff"/>`;
      html += `<text x="${n.x+n.w-8}" y="${n.y+11}" text-anchor="middle" font-size="8" fill="#fff" font-weight="700">${viewState.comments.filter(c=>c.nodeId===n.id).length}</text>`;
    }
    html += `<text x="${n.x+n.w/2}" y="${n.y+n.h/2-4}" text-anchor="middle" font-size="12" font-weight="600" fill="${layer.textColor}">${n.label}</text>`;
    html += `<text x="${n.x+n.w/2}" y="${n.y+n.h/2+10}" text-anchor="middle" font-size="9" fill="${layer.textColor}" opacity="0.6" font-family="SF Mono,Monaco,Consolas,monospace">${n.subtitle}</text>`;
    html += '</g>';
  });

  html += '</g>';
  svg.innerHTML = html;
  updatePrompt();
}

// --- Zoom & Pan ---
function zoom(factor) {
  viewState.scale = Math.max(0.3, Math.min(3, viewState.scale * factor));
  render();
}
function resetZoom() {
  viewState.scale = 1; viewState.panX = 0; viewState.panY = 0;
  render();
}

const canvasArea = document.getElementById('canvas-area');
canvasArea.addEventListener('mousedown', e => {
  if(e.target.closest('.node')) return;
  isPanning = true;
  panStart = {x:e.clientX - viewState.panX, y:e.clientY - viewState.panY};
  canvasArea.style.cursor = 'grabbing';
});
canvasArea.addEventListener('mousemove', e => {
  if(!isPanning) return;
  viewState.panX = e.clientX - panStart.x;
  viewState.panY = e.clientY - panStart.y;
  render();
});
canvasArea.addEventListener('mouseup', () => { isPanning = false; canvasArea.style.cursor = 'default'; });
canvasArea.addEventListener('wheel', e => {
  e.preventDefault();
  zoom(e.deltaY < 0 ? 1.08 : 1/1.08);
}, {passive:false});

// --- Comment system ---
function openModal(nodeId) {
  modalNodeId = nodeId;
  const node = NODES.find(n => n.id === nodeId);
  document.getElementById('modal-title').textContent = node.label;
  document.getElementById('modal-file').textContent = node.subtitle;
  const existing = viewState.comments.find(c => c.nodeId === nodeId);
  document.getElementById('modal-text').value = existing ? existing.text : '';
  document.getElementById('modal').classList.add('open');
  document.getElementById('modal-text').focus();
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
  modalNodeId = null;
}

function saveComment() {
  const text = document.getElementById('modal-text').value.trim();
  const existing = viewState.comments.findIndex(c => c.nodeId === modalNodeId);
  if(text) {
    const node = NODES.find(n => n.id === modalNodeId);
    const comment = { nodeId:modalNodeId, label:node.label, file:node.subtitle, text };
    if(existing >= 0) viewState.comments[existing] = comment;
    else viewState.comments.push(comment);
  } else if(existing >= 0) {
    viewState.comments.splice(existing, 1);
  }
  closeModal();
  renderComments();
  render();
}

function deleteComment(i) {
  viewState.comments.splice(i, 1);
  renderComments();
  render();
}

function renderComments() {
  const list = document.getElementById('comment-list');
  document.getElementById('comment-count').textContent = viewState.comments.length;
  if(viewState.comments.length === 0) {
    list.innerHTML = '<div class="no-comments">Click a component to add feedback</div>';
    return;
  }
  list.innerHTML = viewState.comments.map((c,i) =>
    `<div class="comment-item">
      <button class="del" onclick="deleteComment(${i})">&times;</button>
      <div class="target">${c.label}</div>
      <div class="file">${c.file}</div>
      <div class="text">${c.text}</div>
    </div>`
  ).join('');
}

// --- Prompt output ---
function updatePrompt() {
  const el = document.getElementById('prompt-output');
  if(viewState.comments.length === 0) {
    el.textContent = 'Click components on the map to add architecture feedback and implementation notes.';
    return;
  }

  const visibleLayers = Object.entries(viewState.layers).filter(([,v])=>v).map(([k])=>LAYERS[k].label);
  let prompt = `SuiteScript Generator architecture feedback`;
  if(visibleLayers.length < 5) prompt += ` (focusing on: ${visibleLayers.join(', ')})`;
  prompt += ':\n\n';

  viewState.comments.forEach(c => {
    prompt += `**${c.label}** (${c.file}):\n${c.text}\n\n`;
  });

  prompt += 'Apply these changes following the thin-edge/thick-core pattern. The runner orchestrates all flow steps deterministically from the IR. Edge scripts should only wire into runner.run(ir, context).';

  el.textContent = prompt;
}

function copyPrompt() {
  const text = document.getElementById('prompt-output').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'Copied!'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy Prompt'; btn.classList.remove('copied'); }, 1500);
  });
}

// --- Init ---
renderFilters();
renderComments();
render();
</script>
</body>
</html>
